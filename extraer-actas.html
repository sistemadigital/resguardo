<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Extractor de Datos Firebase a JSON</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; color: #666; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Extractor ACTAS</h1>
        <p>Este script descarga tu base de datos de Firebase como JSON.</p>
        
        <button id="btnDescargar" onclick="extraerDatos()">
            1. Conectar y Extraer Datos
        </button>

        <div id="status">Esperando acción...</div>
    </div>

    <script>
        // --- COPIA AQUÍ TU CONFIGURACIÓN DE FIREBASE (La que usas en actas.html) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtSSWM5UL65Y1xlC-0ca2rx5lOD-TJZxA",
            authDomain: "libro-actas.firebaseapp.com",
            projectId: "libro-actas",
            storageBucket: "libro-actas.firebasestorage.app",
            messagingSenderId: "945356506952",
            appId: "1:945356506952:web:778cfda4ccb53b5282957d"
        };
        // -------------------------------------------------------------------------

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function extraerDatos() {
            const btn = document.getElementById('btnDescargar');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            status.innerText = "Conectando con Firestore...";

            try {
                // Nombre de la colección según tu código original
                const querySnapshot = await db.collection("actas").get();
                const datos = [];

                querySnapshot.forEach((doc) => {
                    // Obtenemos los datos y añadimos el ID por si acaso
                    const data = doc.data();
                    
                    // Convertimos los Timestamps de Firebase a texto legible si existen
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate().toISOString();
                    }

                    datos.push(data);
                });

                if (datos.length === 0) {
                    status.innerText = "No se encontraron datos en la colección 'actas'.";
                    btn.disabled = false;
                    return;
                }

                status.innerText = `Se encontraron ${datos.length} actas. Generando archivo...`;
                downloadObjectAsJson(datos, "respaldo_actas_firebase");
                status.innerText = "¡Descarga completada!";
                btn.disabled = false;

            } catch (error) {
                console.error("Error:", error);
                status.innerText = "Error: " + error.message;
                btn.disabled = false;
            }
        }

        function downloadObjectAsJson(exportObj, exportName) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>

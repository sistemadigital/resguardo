<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Extractor de Datos Firebase a JSON</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; max-width: 400px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        button:disabled { background: #ccc; }
        #status { margin-top: 1rem; color: #666; }
    </style>
</head>
<body>

<div class="card">
    <h2>Extractor de Oficios</h2>
    <p>Este script descargará toda tu colección de Firebase en un archivo .json</p>
    <button id="btnExtraer">Comenzar Extracción</button>
    <p id="status">Esperando inicio...</p>
</div>

<script>
    // 1. PEGA AQUÍ TUS CREDENCIALES DEL ARCHIVO ORIGINAL (oficios.html)
    const firebaseConfig = {
        apiKey: "AIzaSyDbsfhav_5D3aG0yev-p2fl_vtBLCmmQpk",
            authDomain: "libro-oficios.firebaseapp.com",
            projectId: "libro-oficios",
            storageBucket: "libro-oficios.firebasestorage.app",
            messagingSenderId: "141084330855",
            appId: "1:141084330855:web:caf90706a746c6f3b0bdc2"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const btn = document.getElementById('btnExtraer');
    const status = document.getElementById('status');

    btn.addEventListener('click', async () => {
        try {
            btn.disabled = true;
            status.textContent = "Conectando con Firebase...";

            // 2. Cambia 'oficios' por el nombre exacto de tu colección si es diferente
            const querySnapshot = await db.collection('oficios').get();
            
            const data = [];
            querySnapshot.forEach((doc) => {
                let docData = doc.data();
                
                // Procesar fechas de Firebase (Timestamp) a String legible para el JSON
                for (let key in docData) {
                    if (docData[key] && typeof docData[key].toDate === 'function') {
                        docData[key] = docData[key].toDate().toLocaleDateString('es-ES');
                    }
                }
                
                data.push({
                    id: doc.id,
                    ...docData
                });
            });

            if (data.length === 0) {
                status.textContent = "No se encontraron documentos en la colección.";
                btn.disabled = false;
                return;
            }

            status.textContent = `Se encontraron ${data.length} registros. Descargando...`;

            // 3. Generar el archivo JSON
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_oficios_firebase_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            status.textContent = "¡Descarga completada con éxito!";
            btn.disabled = false;

        } catch (error) {
            console.error("Error:", error);
            status.textContent = "Error: " + error.message;
            btn.disabled = false;
        }
    });
</script>

</body>
</html>
